name: Pillole quotidiane

on:
  schedule:
    - cron: "5 6 * * *"   # 07:05 in Italia quando siamo in ora solare (UTC+1)
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate pillola (OpenAI) -> data/news.json
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > gen.mjs <<'EOF'
          import fs from "fs";

const today = new Date().toISOString().slice(0, 10);

const path = "data/news.json";
const arr = fs.existsSync(path)
  ? JSON.parse(fs.readFileSync(path, "utf8"))
  : [];

const recentTitles = arr.slice(0, 40).map(x => x.title).join(" | ");

const prompt = `
Devi scrivere un articolo per il blog dello Studio Paganelli.

Studio Paganelli opera prevalentemente tra Loano e Pietra Ligure.
Genova può essere citata solo come riferimento a casi passati (non è più area operativa principale).

TEMI GIÀ TRATTATI RECENTEMENTE:
${recentTitles}

Non ripetere né riformulare in modo simile nessuno dei temi sopra indicati.
Scegli un argomento sostanzialmente diverso.

Scrivi un articolo di circa 800 parole su un tema concreto di diritto o gestione condominiale.

Tono:
- autorevole ma non accademico
- professionale ma accessibile
- ironia leggera e intelligente
- conclusioni operative e ferme

Struttura:
- apertura con problema reale
- sviluppo pratico
- eventuale breve episodio professionale (massimo 10 righe, non autocelebrativo)
- chiusura con indicazioni operative concrete

Non inventare riferimenti normativi.

Firma finale obbligatoria:
Studio Paganelli – Amministrazione e consulenza condominiale in Liguria.

OUTPUT SOLO JSON valido:
{
  "title": "...",
  "body": "...",
  "tags": ["...", "..."]
}
`;
          const r = await fetch("https://api.openai.com/v1/responses", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "gpt-4.1-mini",
              input: prompt
            })
          });

          if (!r.ok) {
            console.error("OpenAI error:", await r.text());
            process.exit(1);
          }

          const data = await r.json();
          const text = (data.output_text || "").trim();

          let obj;
          try {
            obj = JSON.parse(text);
          } catch (e) {
            console.error("Model did not return pure JSON. Raw output:");
            console.error(text);
            process.exit(1);
          }

          const entry = {
            date: today,
            title: String(obj.title || "").trim(),
            body: String(obj.body || "").trim(),
            tags: Array.isArray(obj.tags) ? obj.tags.map(t => String(t).trim()).filter(Boolean) : []
          };

          if (!entry.title || !entry.body) {
            console.error("Invalid entry generated:", entry);
            process.exit(1);
          }

          const path = "data/news.json";
          const arr = fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, "utf8")) : [];
          if (!Array.isArray(arr)) throw new Error("data/news.json must be an array");

          // evita doppioni stesso giorno
          const filtered = arr.filter(x => x?.date !== today);
          filtered.unshift(entry);

          // tieni al massimo 120 pillole (circa 4 mesi)
          const capped = filtered.slice(0, 120);

          fs.writeFileSync(path, JSON.stringify(capped, null, 2) + "\n");
          console.log("Updated", path);
          EOF

          node gen.mjs

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: pillole/${{ github.run_id }}
          title: "Pillola di condominio – ${{
            github.run_id
          }}"
          commit-message: "Aggiorna data/news.json (pillola)"
          body: |
            PR automatica: nuova pillola pronta.
            Approva questa PR per pubblicare sul sito.
          labels: pillole
