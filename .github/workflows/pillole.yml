name: Pillole quotidiane

on:
  schedule:
    - cron: "5 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure data folder exists
        run: |
          mkdir -p data
          if [ ! -f data/news.json ]; then
            echo "[]" > data/news.json
          fi

      - name: Generate pillola (OpenAI) -> data/news.json
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > gen.mjs <<'EOF'
          import fs from "fs";

          if (!process.env.OPENAI_API_KEY) {
            console.error("Missing OPENAI_API_KEY secret.");
            process.exit(1);
          }

          const today = new Date().toISOString().slice(0, 10);
          const path = "data/news.json";

          // Load archive
          let arr = [];
          try {
            arr = fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, "utf8")) : [];
            if (!Array.isArray(arr)) arr = [];
          } catch {
            arr = [];
          }

          // Memory: last 40 titles
          const recentTitlesList = arr
            .slice(0, 40)
            .map(x => (x?.title ?? "").trim())
            .filter(Boolean);

          const recentTitles = recentTitlesList.length
            ? recentTitlesList.join(" | ")
            : "(nessuno)";

          const prompt = `
          Scrivi un articolo di circa 800 parole per il blog di uno studio di amministrazione condominiale.

          CONTESTO:
          Lo Studio opera prevalentemente tra Loano e Pietra Ligure.
          Genova può essere citata solo come riferimento a casi passati (non è più area operativa principale).

          ANTI-RIPETIZIONI (TEMI GIÀ TRATTATI RECENTEMENTE: NON RIPETERE):
          ${recentTitles}

          Regole:
          - Non ripetere né riformulare in modo simile nessuno dei temi sopra.
          - Se un tema è affine, scegli un angolo DAVVERO diverso (non “stesso tema con titolo diverso”).

          OBIETTIVO:
          Tratta un tema concreto di diritto o gestione condominiale (legale, tecnico, amministrativo o normativo)
          con taglio pratico e operativo.

          TONO:
          - autorevole ma non accademico
          - professionale ma accessibile
          - leggera ironia intelligente, mai caricaturale
          - conclusioni ferme

          STILE:
          - Parti da un problema reale o da una domanda tipica della pratica.
          - Evita burocratese e spiegazioni da manuale universitario.
          - Evita citazioni normative letterali salvo necessità.

          EPISODIO (solo se naturale, non obbligatorio):
          - massimo 8–10 righe
          - nessun nome o dettaglio identificativo
          - non drammatico per forza
          - non autocelebrativo
          - deve servire a chiarire il principio (non diventare racconto)

          CHIUSURA OBBLIGATORIA:
          Inserisci una sezione finale "Cosa fare in pratica" con 3–5 punti elenco concreti
          (cosa verificare / cosa evitare / cosa fare).

          NOVITÀ:
          Se non hai certezza assoluta di novità normative/giurisprudenziali, NON inventare riferimenti.

          FIRMA FINALE OBBLIGATORIA (ultima riga dell’articolo):
          Studio Paganelli – Amministrazione e consulenza condominiale in Liguria.

          OUTPUT OBBLIGATORIO:
          Restituisci SOLO JSON valido (niente markdown, niente testo extra), struttura:
          {
            "title": "...",
            "body": "...",
            "tags": ["...", "...", "..."]
          }
          `.trim();

          async function callOpenAI(userPrompt, maxTokens = 1700) {
            const r = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "gpt-5-mini",
                input: [
                  { role: "system", content: "You must output ONLY valid JSON. No markdown. No extra text." },
                  { role: "user", content: userPrompt }
                ],
                max_output_tokens: maxTokens
              })
            });

            if (!r.ok) {
              console.error("OpenAI error:", await r.text());
              process.exit(1);
            }
            return await r.json();
          }

          function extractJsonObject(text) {
            const t = (text || "").trim();

            // 1) direct parse
            try {
              const obj = JSON.parse(t);
              if (obj && typeof obj === "object") return obj;
            } catch {}

            // 2) extract first {...} block
            const start = t.indexOf("{");
            const end = t.lastIndexOf("}");
            if (start !== -1 && end !== -1 && end > start) {
              const sub = t.slice(start, end + 1);
              try {
                const obj = JSON.parse(sub);
                if (obj && typeof obj === "object") return obj;
              } catch {}
            }

            return null;
          }

          // First attempt
          const data1 = await callOpenAI(prompt, 1800);
          const text1 = (data1.output_text || "").trim();
          console.log("RAW OUTPUT (first 1200 chars):", text1.slice(0, 1200));

          let obj = extractJsonObject(text1);

          // Repair pass if needed
          if (!obj) {
            const repairPrompt = `
          Il testo seguente dovrebbe essere un JSON valido con struttura:
          {
            "title": "...",
            "body": "...",
            "tags": ["...", "...", "..."]
          }
          Correggi SOLO la sintassi e restituisci SOLO JSON valido. Nessun testo extra.

          TESTO:
          ${text1}
          `.trim();

            const data2 = await callOpenAI(repairPrompt, 900);
            const text2 = (data2.output_text || "").trim();
            console.log("REPAIRED OUTPUT (first 1200 chars):", text2.slice(0, 1200));

            obj = extractJsonObject(text2);
          }

          if (!obj) {
            console.error("Model did not return valid JSON even after repair.");
            process.exit(1);
          }

          const entry = {
            date: today,
            title: String(obj.title || "").trim(),
            body: String(obj.body || "").trim(),
            tags: Array.isArray(obj.tags)
              ? obj.tags.map(t => String(t).trim()).filter(Boolean)
              : []
          };

          if (!entry.title || !entry.body) {
            console.error("Invalid entry generated:", entry);
            process.exit(1);
          }

          // Remove duplicates for the same date, prepend new entry
          const filtered = arr.filter(x => x?.date !== today);
          filtered.unshift(entry);

          // Keep max 180 posts (~6 mesi)
          const capped = filtered.slice(0, 180);

          fs.writeFileSync(path, JSON.stringify(capped, null, 2) + "\n");
          console.log("Updated", path);
          EOF

          node gen.mjs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: pillole/${{ github.run_id }}
          title: "Pillola di condominio - ${{ github.run_id }}"
          commit-message: "Aggiorna data/news.json (pillola)"
          body: |
            PR automatica: nuova pillola pronta.
            Controlla e fai merge per pubblicare sul sito.
          labels: pillole
